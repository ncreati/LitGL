
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>litGL.fontDistiller &#8212; litGL 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">litGL 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">litGL.fontDistiller</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for litGL.fontDistiller</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Font glyphs distiller</span>

<span class="sd">    Author:</span>
<span class="sd">            - 2020-2021 Nicola Creati</span>

<span class="sd">            - 2020-2021 Roberto Vidmar</span>

<span class="sd">        Copyright:</span>
<span class="sd">            2020-2021 Nicola Creati &lt;ncreati@inogs.it&gt;</span>

<span class="sd">            2020-2021 Roberto Vidmar &lt;rvidmar@inogs.it&gt;</span>

<span class="sd">        License:</span>
<span class="sd">            MIT/X11 License (see</span>
<span class="sd">            :download:`license.txt &lt;../../../license.txt&gt;`)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">fontTools.unicode</span> <span class="kn">import</span> <span class="n">Unicode</span>
<span class="kn">from</span> <span class="nn">fontTools.pens.cu2quPen</span> <span class="kn">import</span> <span class="n">Cu2QuPen</span>
<span class="kn">from</span> <span class="nn">fontTools.pens.ttGlyphPen</span> <span class="kn">import</span> <span class="n">TTGlyphPen</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib</span> <span class="kn">import</span> <span class="n">TTFont</span><span class="p">,</span> <span class="n">newTable</span><span class="p">,</span> <span class="n">TTLibError</span>
<span class="kn">import</span> <span class="nn">numpy.lib.recfunctions</span> <span class="k">as</span> <span class="nn">nrec</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">.glyph</span> <span class="kn">import</span> <span class="n">Glyph</span><span class="p">,</span> <span class="n">BitmapAtlas</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="key_from_value"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.key_from_value">[docs]</a><span class="k">def</span> <span class="nf">key_from_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return key for value `v` in dictionary `d`.</span>

<span class="sd">        Args:</span>
<span class="sd">            v (object): value</span>
<span class="sd">            d (dict): dictionary</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: key for value `v` in dictionary `d` or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate key for value &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="s2">&quot; in the character map&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ret</span> <span class="k">else</span> <span class="kc">None</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="normalize_outlines"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.normalize_outlines">[docs]</a><span class="k">def</span> <span class="nf">normalize_outlines</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Normalize Bezier curves vertices coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (:class:`numpy.ndarray`): structured array with Bezier curves</span>
<span class="sd">                vertices</span>
<span class="sd">            xs (float): x scale factor</span>
<span class="sd">            ys (float): y scale factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">contour</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>
        <span class="n">contour</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>
        <span class="n">contour</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="remove_cubic"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.remove_cubic">[docs]</a><span class="k">def</span> <span class="nf">remove_cubic</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Remove cubic dummy vertices from the structured array of Bezier curves.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (:class:`numpy.ndarray`)): structured array with Bezier</span>
<span class="sd">                curves vertices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newData</span> <span class="o">=</span> <span class="p">[</span><span class="n">nrec</span><span class="o">.</span><span class="n">drop_fields</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="s1">&#39;p3&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">nrec</span><span class="o">.</span><span class="n">rename_fields</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;p4&#39;</span><span class="p">:</span><span class="s1">&#39;p3&#39;</span><span class="p">})</span> <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">newData</span><span class="p">]</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sort_bands"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.sort_bands">[docs]</a><span class="k">def</span> <span class="nf">sort_bands</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort Bezier curves inside band in direction specified by `mode`.</span>

<span class="sd">        Args:</span>
<span class="sd">            outlines (:class:`numpy.ndarray`): structured array with Bezier</span>
<span class="sd">                curves vertices</span>
<span class="sd">            bands (list): list of Bezier curves in each band</span>
<span class="sd">            mode (str): direction of sorting: either &#39;x&#39; or &#39;y&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: sorted bands in the requested direction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sortedBands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
        <span class="n">curves</span> <span class="o">=</span> <span class="n">outlines</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span>
        <span class="n">cMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">curves</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">][:,</span> <span class="n">index</span><span class="p">],</span> <span class="n">curves</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="n">index</span><span class="p">],</span>
                <span class="n">curves</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">][:,</span> <span class="n">index</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cMax</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sortedBands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sortedBands</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bandIntersections"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.bandIntersections">[docs]</a><span class="k">def</span> <span class="nf">bandIntersections</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return index of bezier curves inside bands.</span>

<span class="sd">        Args:</span>
<span class="sd">            outlines (:class:`numpy.ndarray`): structured array with Bezier</span>
<span class="sd">                curves vertices</span>
<span class="sd">            bands (tuple): number of bands in the horizontal and vertical</span>
<span class="sd">                direction</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: sorted bands in x and y direction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nh</span><span class="p">,</span> <span class="n">nv</span> <span class="o">=</span> <span class="n">bands</span>
    <span class="n">hBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nv</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">hb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Parallel test cause artefact</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">((</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">yMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">yMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hBands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hBands</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="p">(</span><span class="n">yMin</span> <span class="o">&gt;</span> <span class="n">b1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">yMax</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">hb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ind2</span><span class="p">)])</span>

    <span class="c1">## Work on vertical bands</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Parallel test cause artefacts</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">((</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">outlines</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">xMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vBands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vBands</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xMin</span> <span class="o">&gt;</span> <span class="n">b1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">&lt;</span> <span class="n">b0</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="n">vb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ind2</span><span class="p">)])</span>

    <span class="c1"># Sort curve in ascending order</span>
    <span class="c1"># Horizontal bands from max x</span>
    <span class="n">hb</span> <span class="o">=</span> <span class="n">sort_bands</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">hb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="c1"># Verticalal bands from max y</span>
    <span class="n">vb</span> <span class="o">=</span> <span class="n">sort_bands</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hb</span><span class="p">,</span> <span class="n">vb</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="cff_to_glyf"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.cff_to_glyf">[docs]</a><span class="k">def</span> <span class="nf">cff_to_glyf</span><span class="p">(</span><span class="n">face</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert the CFF/CFF2 table to a glyf table</span>

<span class="sd">        Args:</span>
<span class="sd">            face (:class:`fontTools.ttLib:TTFont`): instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: of :class:`fontTools.ttLib.tables._g_l_y_f.Glyph` instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">glyphs_to_quadratic</span><span class="p">(</span><span class="n">glyphs</span><span class="p">,</span> <span class="n">max_err</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reverse_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">quadGlyphs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">glyphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">glyph</span> <span class="o">=</span> <span class="n">glyphs</span><span class="p">[</span><span class="n">gname</span><span class="p">]</span>
            <span class="n">ttPen</span> <span class="o">=</span> <span class="n">TTGlyphPen</span><span class="p">(</span><span class="n">glyphs</span><span class="p">)</span>
            <span class="n">cu2quPen</span> <span class="o">=</span> <span class="n">Cu2QuPen</span><span class="p">(</span><span class="n">ttPen</span><span class="p">,</span> <span class="n">max_err</span><span class="p">,</span>
                                <span class="n">reverse_direction</span><span class="o">=</span><span class="n">reverse_direction</span><span class="p">)</span>
            <span class="n">glyph</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">cu2quPen</span><span class="p">)</span>
            <span class="n">quadGlyphs</span><span class="p">[</span><span class="n">gname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttPen</span><span class="o">.</span><span class="n">glyph</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">quadGlyphs</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">update_hmtx</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">glyf</span><span class="p">):</span>
        <span class="n">hmtx</span> <span class="o">=</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;hmtx&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyph</span> <span class="ow">in</span> <span class="n">glyf</span><span class="o">.</span><span class="n">glyphs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">glyph</span><span class="p">,</span> <span class="s1">&#39;xMin&#39;</span><span class="p">):</span>
                <span class="n">hmtx</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hmtx</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">glyph</span><span class="o">.</span><span class="n">xMin</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">assert</span> <span class="n">face</span><span class="o">.</span><span class="n">sfntVersion</span> <span class="o">==</span> <span class="s2">&quot;OTTO&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;CFF &quot;</span> <span class="ow">in</span> <span class="n">face</span>

    <span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">getGlyphOrder</span><span class="p">()</span>

    <span class="n">face</span><span class="p">[</span><span class="s2">&quot;loca&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newTable</span><span class="p">(</span><span class="s2">&quot;loca&quot;</span><span class="p">)</span>
    <span class="n">face</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glyf</span> <span class="o">=</span> <span class="n">newTable</span><span class="p">(</span><span class="s2">&quot;glyf&quot;</span><span class="p">)</span>
    <span class="n">glyf</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">glyphOrder</span>
    <span class="n">glyf</span><span class="o">.</span><span class="n">glyphs</span> <span class="o">=</span> <span class="n">glyphs_to_quadratic</span><span class="p">(</span><span class="n">face</span><span class="o">.</span><span class="n">getGlyphSet</span><span class="p">())</span>
    <span class="k">del</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;CFF &quot;</span><span class="p">]</span>
    <span class="n">glyf</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
    <span class="n">update_hmtx</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">glyf</span><span class="p">)</span>

    <span class="n">face</span><span class="p">[</span><span class="s2">&quot;maxp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">newTable</span><span class="p">(</span><span class="s2">&quot;maxp&quot;</span><span class="p">)</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">tableVersion</span> <span class="o">=</span> <span class="mh">0x00010000</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxZones</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxTwilightPoints</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxStorage</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxFunctionDefs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxInstructionDefs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxStackElements</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxSizeOfInstructions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">maxComponentElements</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">components</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;components&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">glyf</span><span class="o">.</span><span class="n">glyphs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">maxp</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>

    <span class="n">post</span> <span class="o">=</span> <span class="n">face</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]</span>
    <span class="c1"># default &#39;post&#39; table format</span>
    <span class="n">post</span><span class="o">.</span><span class="n">formatType</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">post</span><span class="o">.</span><span class="n">extraNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">post</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">post</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">glyphOrder</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">formatType</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dropping glyph names, they do not fit in &#39;post&#39; table.&quot;</span><span class="p">)</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="glyferize"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.glyferize">[docs]</a><span class="k">def</span> <span class="nf">glyferize</span><span class="p">(</span><span class="n">glyf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">codePoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Extract glyph attributes from the TTF glyf table</span>

<span class="sd">        Args:</span>
<span class="sd">            glyf (:class:`fontTools.ttLib.tables._g_l_y_f.Glyph`): instance</span>
<span class="sd">            name (str): glyph name</span>
<span class="sd">            codePoint (int): unicode code point</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`Glyph`: new Glyph instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">Glyph</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">codePoint</span> <span class="o">=</span> <span class="n">codePoint</span>
    <span class="n">g</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">glyf</span><span class="o">.</span><span class="n">getGlyphID</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">charCode</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">codePoint</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">codePoint</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">charCode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">charCode</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">g</span></div>

<span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="GlyphTypes"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.GlyphTypes">[docs]</a><span class="k">class</span> <span class="nc">GlyphTypes</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="c1">#: Basic (monochrome) glyph</span>
    <span class="n">BASE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#: Colored glyph with layered structure</span>
    <span class="n">LAYER_COLOR</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#: Colored Bitmap glyph</span>
    <span class="n">CBDT_COLOR</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1">#: Black and white Bitmap glyph</span>
    <span class="n">EBDT_COLOR</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1">#: Colored Bitmap glyph (Apple implementation)</span>
    <span class="n">SBIX_COLOR</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1">#: SVG glyph</span>
    <span class="n">SVG_COLOR</span> <span class="o">=</span> <span class="mi">5</span></div>

<span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="FontDistiller"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller">[docs]</a><span class="k">class</span> <span class="nc">FontDistiller</span><span class="p">:</span>
    <span class="c1">#: The suffix for the distilled fonts</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s1">&#39;.nbf&#39;</span>
    <span class="c1">#: The default folder for distilled fonts</span>
    <span class="n">NBF_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="s2">&quot;.local/share/fonts/nbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FontDistiller.__init__"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fontFile</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a FontDistiller instance.</span>

<span class="sd">            Args:</span>
<span class="sd">                fontFile (str): pathname of font file</span>
<span class="sd">                bands (int): number of horizontal and vertical bands,</span>
<span class="sd">                    0 means automatic selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">face</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">fontFile</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allowVID</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TTLibError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot distill </span><span class="si">{</span><span class="n">fontFile</span><span class="si">}</span><span class="s2">: reason is&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="c1">#Note: It is strongly advised that you do not add any handlers</span>
        <span class="c1">#other than NullHandler to your library’s loggers.</span>
        <span class="c1">#This is because the configuration of handlers is the prerogative</span>
        <span class="c1">#of the application developer who uses your library.</span>
        <span class="c1">#The application developer knows their target audience and what</span>
        <span class="c1">#handlers are most appropriate for their application:</span>
        <span class="c1">#if you add handlers ‘under the hood’, you might well interfere</span>
        <span class="c1">#with their ability to carry out unit tests and deliver logs which</span>
        <span class="c1">#suit their requirements.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Face defined tables:</span><span class="se">\n</span><span class="s1">==&gt;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&gt;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontFile</span> <span class="o">=</span> <span class="n">fontFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorsArray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorsArrayShape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesArray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandsArray</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dict of glyphs unicode code point(integers) as keys and glyph names</span>
        <span class="c1"># as values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">getBestCmap</span><span class="p">()</span>

        <span class="c1"># bands 0 means automatic selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span> <span class="o">=</span> <span class="n">bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># HEAD: https://docs.microsoft.com/en-us/typography/opentype/spec/head</span>
        <span class="c1"># This table gives global information about the font.</span>
        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">fontDirectionHint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fontDirection</span> <span class="o">=</span> <span class="s1">&#39;mixed&#39;</span>
        <span class="k">elif</span> <span class="n">head</span><span class="o">.</span><span class="n">fontDirectionHint</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fontDirection</span> <span class="o">=</span> <span class="s1">&#39;lr&#39;</span>
        <span class="k">elif</span> <span class="n">head</span><span class="o">.</span><span class="n">fontDirectionHint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fontDirection</span> <span class="o">=</span> <span class="s1">&#39;rl&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fontDirection</span> <span class="o">=</span> <span class="s1">&#39;mixed&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kerningTable</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;kern&#39;</span><span class="p">):</span>
            <span class="n">kern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kern&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has kerning&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kern</span><span class="o">.</span><span class="n">kernTables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Font has more than 1 kerning tables.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kerningTable</span> <span class="o">=</span> <span class="n">kern</span><span class="o">.</span><span class="n">kernTables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kernTable</span>

        <span class="n">linespace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ascent</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">descent</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lineGap</span><span class="p">)</span>

        <span class="c1"># HMTX: https://docs.microsoft.com/en-us/typography/opentype/spec/hmtx</span>
        <span class="c1"># Glyph metrics used for horizontal text layout</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;hmtx&#39;</span><span class="p">):</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has horizontal layout&#39;</span><span class="p">)</span>
        <span class="c1"># VMTX: https://docs.microsoft.com/en-us/typography/opentype/spec/vmtx</span>
        <span class="c1"># Glyph metrics used for vertical text layout</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;vmtx&#39;</span><span class="p">):</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has vertical layout&#39;</span><span class="p">)</span>

        <span class="c1"># Without CPAL color has no meaning</span>
        <span class="c1"># COLR: https://docs.microsoft.com/en-us/typography/opentype/spec/colr</span>
        <span class="c1"># contains a list of colored glyph and their associated glyph layers</span>
        <span class="c1"># CPAL: https://docs.microsoft.com/en-us/typography/opentype/spec/cpal</span>
        <span class="c1"># The palette table is a set of one or more palettes, each containing</span>
        <span class="c1"># a predefined number of color records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cglyphs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;COLR&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;CPAL&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">=</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span>
            <span class="c1"># Dict of font with colors each value is a list of records</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;COLR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ColorLayers</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has colors&#39;</span><span class="p">)</span>

            <span class="c1"># Extract the color palette</span>
            <span class="n">cpal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CPAL&#39;</span><span class="p">)</span>
            <span class="c1"># cpal.palettesTypes can be:</span>
            <span class="c1"># USABLE_WITH_LIGHT_BACKGROUND 0</span>
            <span class="c1"># USABLE_WITH_DARK_BACKGROUND 1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">palettes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">paletteType</span> <span class="ow">in</span> <span class="n">cpal</span><span class="o">.</span><span class="n">palettes</span><span class="p">:</span>
                <span class="n">rgba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cpal</span><span class="o">.</span><span class="n">numPaletteEntries</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paletteType</span><span class="p">):</span>
                    <span class="n">rgba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgba</span><span class="p">)</span>

        <span class="c1"># Colord Bitmap as glyphs</span>
        <span class="c1"># CBDT: https://docs.microsoft.com/en-us/typography/opentype/spec/cbdt</span>
        <span class="c1"># The CBDT table is used to embed color bitmap glyph data.</span>
        <span class="c1"># CBLC: https://docs.microsoft.com/en-us/typography/opentype/spec/cblc</span>
        <span class="c1"># The CBLC table provides embedded bitmap locators</span>
        <span class="k">if</span> <span class="s1">&#39;CBDT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">:</span>
            <span class="c1"># Bitmap font are stored as byte string of PNG files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">=</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">CBDT_COLOR</span>
        <span class="c1"># Colord Bitmap as glyphs</span>
        <span class="c1"># SBIX: https://docs.microsoft.com/en-us/typography/opentype/spec/sbix</span>
        <span class="c1"># This table provides access to bitmap data in a standard graphics</span>
        <span class="c1"># format, such as PNG, JPEG or TIFF.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;sbix&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">=</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">SBIX_COLOR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has colored bitmap as glyphs:&#39;</span>
                    <span class="s1">&#39; UNSUPPORTED.&#39;</span><span class="p">)</span>

        <span class="c1"># Colord Bitmap as glyphs</span>
        <span class="c1"># SVG: https://docs.microsoft.com/en-us/typography/opentype/spec/svg</span>
        <span class="c1"># This table contains SVG descriptions for some or all of the glyphs</span>
        <span class="c1"># in the font.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;SVG&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">=</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">SVG_COLOR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The face has SVG glyphs: UNSUPPORTED&#39;</span><span class="p">)</span>

        <span class="c1"># HHEA: https://docs.microsoft.com/en-us/typography/opentype/spec/hhea</span>
        <span class="c1"># This table contains information for horizontal layout.</span>
        <span class="n">hhea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span>

        <span class="c1"># OS/2: https://docs.microsoft.com/en-us/typography/opentype/spec/os2</span>
        <span class="c1"># The OS/2 table consists of a set of metrics and other data that are</span>
        <span class="c1"># required in OpenType fonts.</span>

        <span class="c1"># POST: https://docs.microsoft.com/en-us/typography/opentype/spec/post</span>
        <span class="c1"># This table contains additional information needed to use TrueType or</span>
        <span class="c1"># OpenType™ fonts on PostScript printers. This includes data for the</span>
        <span class="c1"># FontInfo dictionary entry and the PostScript names of all the glyphs</span>

        <span class="c1"># MAXP: https://docs.microsoft.com/en-us/typography/opentype/spec/maxp</span>
        <span class="c1"># This table establishes the memory requirements for this font.</span>

        <span class="c1"># Save several face parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># map character name to integer ordinal value</span>
                <span class="s1">&#39;cmap&#39;</span>                <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="s1">&#39;ascent&#39;</span>              <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ascent</span><span class="p">,</span>
                <span class="s1">&#39;lineGap&#39;</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lineGap</span><span class="p">,</span>
                <span class="s1">&#39;descent&#39;</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">descent</span><span class="p">,</span>
                <span class="s1">&#39;linespace&#39;</span>           <span class="p">:</span> <span class="n">linespace</span><span class="p">,</span>
                <span class="s1">&#39;family_name&#39;</span>         <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">toStr</span><span class="p">(),</span>
                <span class="s1">&#39;glyphs&#39;</span>              <span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;glyphTypes&#39;</span>          <span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;colored&#39;</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span><span class="p">,</span>
                <span class="s1">&#39;kerning_table&#39;</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kerningTable</span><span class="p">,</span>
                <span class="s1">&#39;fontRevision&#39;</span>        <span class="p">:</span> <span class="n">head</span><span class="o">.</span><span class="n">fontRevision</span><span class="p">,</span>
                <span class="s1">&#39;minLeftSideBearing&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minLeftSideBearing</span><span class="p">,</span>
                <span class="s1">&#39;minRightSideBearing&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minRightSideBearing</span><span class="p">,</span>
                <span class="s1">&#39;fontDirection&#39;</span>       <span class="p">:</span> <span class="n">fontDirection</span><span class="p">,</span>
                <span class="s1">&#39;layout&#39;</span>              <span class="p">:</span> <span class="n">layout</span><span class="p">,</span>
                <span class="s1">&#39;max_advance_width&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hhea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">advanceWidthMax</span><span class="p">,</span>
                <span class="s1">&#39;num_glyphs&#39;</span>          <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numGlyphs</span><span class="p">,</span>
                <span class="s1">&#39;style_name&#39;</span>          <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">toStr</span><span class="p">(),</span>
                <span class="s1">&#39;underline_position&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;post&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">underlinePosition</span><span class="p">,</span>
                <span class="s1">&#39;underline_thickness&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;post&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">underlineThickness</span><span class="p">,</span>
                <span class="s1">&#39;box&#39;</span>                 <span class="p">:</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">xMax</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yMin</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yMax</span>
                        <span class="p">),</span>
                <span class="s1">&#39;ySubscriptXSize&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySubscriptXSize</span><span class="p">,</span>
                <span class="s1">&#39;ySubscriptYSize&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySubscriptYSize</span><span class="p">,</span>
                <span class="s1">&#39;ySubscriptXOffset&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySubscriptXOffset</span><span class="p">,</span>
                <span class="s1">&#39;ySubscriptYOffset&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySubscriptYOffset</span><span class="p">,</span>
                <span class="s1">&#39;ySuperscriptXSize&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySuperscriptXSize</span><span class="p">,</span>
                <span class="s1">&#39;ySuperscriptYSize&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySuperscriptYSize</span><span class="p">,</span>
                <span class="s1">&#39;ySuperscriptXOffset&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySuperscriptXOffset</span><span class="p">,</span>
                <span class="s1">&#39;ySuperscriptYOffset&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ySuperscriptYOffset</span><span class="p">,</span>
                <span class="s1">&#39;yStrikeoutSize&#39;</span>      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yStrikeoutSize</span><span class="p">,</span>
                <span class="s1">&#39;yStrikeoutPosition&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yStrikeoutPosition</span><span class="p">,</span>
                <span class="s1">&#39;fsFirstCharIndex&#39;</span>    <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fsFirstCharIndex</span><span class="p">,</span>
                <span class="s1">&#39;fsLastCharIndex&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS/2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fsLastCharIndex</span><span class="p">,</span>
                <span class="s1">&#39;units_per_EM&#39;</span>        <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unitsPerEm</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span>              <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yMax</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">yMin</span><span class="p">),</span>
                <span class="s1">&#39;width&#39;</span>               <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">xMax</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">xMin</span><span class="p">),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Check LTSH table!!&#39;</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">glyf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">glyf</span><span class="p">:</span>
            <span class="c1">#######################################################</span>
            <span class="c1"># If glyf table is missing there are some alternatives:</span>
            <span class="c1"># CFF/CFF2 Adobe glyph table or Bitmap glyphs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No glyf table available&#39;</span><span class="p">)</span>
            <span class="c1"># Try CFF</span>
            <span class="n">cff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CFF &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CFF2&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cff</span><span class="p">:</span>
                <span class="n">cff_to_glyf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">)</span>
                <span class="c1"># extract the builded glyf table</span>
                <span class="n">glyf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Glyphs table from CFF/CFF2&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;CBDT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span> <span class="ow">or</span> <span class="s1">&#39;EBDT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CBDT/EBDT table is available&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">glyf</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">glyf</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">BASE</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">==</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buildColorsLayerArray</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Array of colored layer created&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">==</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">CBDT_COLOR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buildColorCBDTArray</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">CBDT_COLOR</span><span class="p">)</span>
            <span class="n">cblc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;CBLC&#39;</span><span class="p">]</span>
            <span class="n">hori</span> <span class="o">=</span> <span class="n">cblc</span><span class="o">.</span><span class="n">strikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bitmapSizeTable</span><span class="o">.</span><span class="n">hori</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Array of colored bitmap created&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Font </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fontFile</span><span class="si">}</span><span class="s1"> processed in&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FontDistiller.makeGlyphBands"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.makeGlyphBands">[docs]</a>    <span class="k">def</span> <span class="nf">makeGlyphBands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">nBands</span><span class="p">,</span> <span class="n">layered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate glyph curves intersection with defined horizontal and</span>
<span class="sd">            vertical bands, arrange curves array to be saved in the curves</span>
<span class="sd">            texture.</span>

<span class="sd">            Args:</span>
<span class="sd">                g (:class:`fontTools.ttLib.tables._g_l_y_f.Glyph`): glyph</span>
<span class="sd">                nBands (int): number of horizontal and vertical bands,</span>
<span class="sd">                              0 means automatic selection</span>
<span class="sd">                layered (bool): True if the glyph is a colored layer one</span>

<span class="sd">            Returns:</span>
<span class="sd">                :class:`numpy.ndarray`: intersections of the glyph Bezier</span>
<span class="sd">                curves with the bands</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build curve array</span>
        <span class="n">newData</span> <span class="o">=</span> <span class="n">remove_cubic</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">layered</span><span class="p">:</span>
            <span class="n">normalize_outlines</span><span class="p">(</span><span class="n">newData</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Build bandsData</span>
        <span class="n">nCurves</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bezierCount</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nBands</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nBands</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nCurves</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">curves_x_bands</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">: character &lt;</span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">charCode</span><span class="si">}</span><span class="s2">&gt; (</span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; codePoint </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">codePoint</span><span class="si">}</span><span class="s2"> nCurves = </span><span class="si">{</span><span class="n">nCurves</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; curves_x_bands = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">curves_x_bands</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">nBands</span> <span class="o">=</span> <span class="p">(</span><span class="n">nBands</span><span class="p">,</span> <span class="n">nBands</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">newData</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># sposta tutto alla riga successiva</span>
                    <span class="c1"># metti la p3 e passa oltre</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_00</span><span class="p">))])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;A curve was shifted to the next row at&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span><span class="si">}</span><span class="s1"> for glyph&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; -&gt; </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s1"> &lt;&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;p3&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_00</span><span class="p">))])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Strange A curve need to be shifted to next row at&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; -&gt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span><span class="si">}</span><span class="s1"> for glyph &gt; </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s1"> &lt;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_0000</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Glyph Header</span>
        <span class="c1"># calculate curves vs bands</span>
        <span class="n">horzBands</span><span class="p">,</span> <span class="n">vertBands</span> <span class="o">=</span> <span class="n">bandIntersections</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">newData</span><span class="p">),</span>
                <span class="p">(</span><span class="n">nBands</span><span class="p">,</span> <span class="n">nBands</span><span class="p">))</span>

        <span class="c1"># numero bande orizzontali offset all&#39;indice delle curve</span>
        <span class="c1"># numero bande vertricali offset all&#39;indice delle curve</span>
        <span class="c1"># h1(bande), h2(offset)</span>
        <span class="c1"># Bande orizzontali</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">iBand</span><span class="p">)</span> <span class="k">for</span> <span class="n">iBand</span> <span class="ow">in</span> <span class="n">horzBands</span><span class="p">]</span>
        <span class="c1"># Bande verticali</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">iBand</span><span class="p">)</span> <span class="k">for</span> <span class="n">iBand</span> <span class="ow">in</span> <span class="n">vertBands</span><span class="p">]</span>
        <span class="c1"># Appendi alla lista delle bande per ogni glifo</span>
        <span class="n">glyphBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">glyphParam</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">nBands</span><span class="p">,</span> <span class="n">nBands</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+=</span> <span class="mi">0</span>

        <span class="c1"># Wrap is x exceeed texture wifdth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">&amp;=</span> <span class="mi">4095</span>

        <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="s1">&#39;gp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">glyphParam</span>

        <span class="c1"># Fix header horixontal and vertical offset accounting for index</span>
        <span class="c1"># jump at each contour end</span>
        <span class="n">jumps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bezierCount</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bezierCount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">jump</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jumps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hb</span> <span class="ow">in</span> <span class="n">horzBands</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">((</span><span class="n">hb</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">jump</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
                    <span class="n">hb</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">for</span> <span class="n">vb</span> <span class="ow">in</span> <span class="n">vertBands</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">((</span><span class="n">vb</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">jump</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
                    <span class="n">vb</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">horzBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">horzBands</span><span class="p">)</span>
        <span class="n">vertBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">vertBands</span><span class="p">)</span>
        <span class="c1"># Curve index in the band data for the current glyph</span>
        <span class="n">glyphBands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">horzBands</span><span class="p">,</span> <span class="n">vertBands</span><span class="p">))</span>
        <span class="c1"># Add the curve offset for the current glyph</span>
        <span class="n">glyphBands</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvesOffset</span>

        <span class="c1"># Manage shift of curve index at width limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">glyphBands</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span>
            <span class="n">glyphBands</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">## Reset the skipIndex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curvesOffset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">glyphBands</span></div>

<div class="viewcode-block" id="FontDistiller.compositItem"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.compositItem">[docs]</a>    <span class="k">def</span> <span class="nf">compositItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">glyf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process a composite glyph</span>

<span class="sd">            Args:</span>
<span class="sd">                g (:class:`litGL.glyph.Glyph`): glyph</span>
<span class="sd">                name (str): glyph name</span>
<span class="sd">                item (:class:`fontTools.ttLib.tables._g_l_y_f.Glyph`):</span>
<span class="sd">                    component glyph</span>
<span class="sd">                glyf (:class:`fontTools.ttLib.tables._g_l_y_f.table__g_l_y_f`):</span>
<span class="sd">                    father glyph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setMetric</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="c1"># Build compound contours and create the outline arrays</span>
        <span class="n">outlines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="c1"># trasform (xx, xy, yx, yy, x, y). [[xx, xy],[yx, yy]] =</span>
            <span class="c1"># 2x2 matrix transform</span>
            <span class="c1"># x, y affine transform</span>
            <span class="n">componentGlyphName</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getComponentInfo</span><span class="p">()</span>
            <span class="c1"># Two possible options:</span>
            <span class="k">if</span> <span class="n">componentGlyphName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Component already extracted</span>
                <span class="n">contour</span><span class="p">,</span> <span class="n">bezierCount</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">Glyph</span><span class="o">.</span><span class="n">buildOutlineArray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">componentGlyphName</span><span class="p">]</span><span class="o">.</span><span class="n">contours</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">bezierCount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bezierCount</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Glyph componennt must be extracted</span>
                <span class="n">componentItem</span> <span class="o">=</span> <span class="n">glyf</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">componentGlyphName</span><span class="p">]</span>
                <span class="n">cg</span> <span class="o">=</span> <span class="n">glyferize</span><span class="p">(</span><span class="n">glyf</span><span class="p">,</span> <span class="n">componentGlyphName</span><span class="p">)</span>
                <span class="n">cg</span><span class="o">.</span><span class="n">setMetric</span><span class="p">(</span><span class="n">componentItem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">[</span><span class="n">componentGlyphName</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">componentItem</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cg</span><span class="o">.</span><span class="n">extractContours</span><span class="p">(</span><span class="n">componentItem</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">(</span><span class="n">glyf</span><span class="p">))</span>
                    <span class="n">cg</span><span class="o">.</span><span class="n">contours2array</span><span class="p">(</span>
                            <span class="n">x0</span><span class="o">=</span><span class="n">cg</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">cg</span><span class="o">.</span><span class="n">yMin</span><span class="p">)</span>
                    <span class="n">cg</span><span class="o">.</span><span class="n">buildVertices</span><span class="p">()</span>
                    <span class="n">glyphBands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeGlyphBands</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span><span class="p">)</span>

                    <span class="c1"># Add the glyph band curves index to the band data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">componentGlyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="n">cg</span><span class="o">.</span><span class="n">cp</span><span class="p">()]</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">dataTable</span>
                <span class="n">g</span><span class="o">.</span><span class="n">bezierCount</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">bezierCount</span><span class="p">)</span>
                <span class="n">contour</span><span class="p">,</span> <span class="n">bezierCount</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">Glyph</span><span class="o">.</span><span class="n">buildOutlineArray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">componentGlyphName</span><span class="p">]</span><span class="o">.</span><span class="n">contours</span><span class="p">)</span>

            <span class="c1"># Apply transform</span>
            <span class="n">rescaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transform</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">yMin</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">rescaling</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
            <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">outlines</span><span class="p">))</span></div>

<div class="viewcode-block" id="FontDistiller.extract"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extract glyphs from a font file.</span>

<span class="sd">            Args:</span>
<span class="sd">                glyf (:class:`fontTools.ttLib.tables._g_l_y_f.table__g_l_y_f`):</span>
<span class="sd">                    glyf table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">glyf</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">)</span>

        <span class="c1"># Glyph metric</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;hmtx&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hmtx&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;vmtx&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vmtx&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Metric information is missing&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Font </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fontFile</span><span class="si">}</span><span class="s2"> has no CMAP,&quot;</span>
                    <span class="s2">&quot; cannot distill!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reversed_cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">reversed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

        <span class="c1"># Loop over all glyphs in the glyf table extracting also not Unicode</span>
        <span class="c1"># glyph. Char map has only unicode glyphs</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_0000</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curves_x_bands</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">//</span> <span class="mi">16</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipIndex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iBandOffset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesOffset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">xMin</span><span class="p">,</span> <span class="n">xMax</span><span class="p">,</span> <span class="n">yMin</span><span class="p">,</span> <span class="n">yMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span>
        <span class="n">g_width</span> <span class="o">=</span> <span class="n">xMax</span><span class="o">-</span><span class="n">xMin</span>
        <span class="n">g_height</span> <span class="o">=</span> <span class="n">yMax</span><span class="o">-</span><span class="n">yMin</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">glyf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="n">g</span> <span class="o">=</span> <span class="n">glyferize</span><span class="p">(</span><span class="n">glyf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setMetric</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="c1">#g.buildVertices()</span>

            <span class="c1"># Manage composite glyphs, composite glyphs has a number of</span>
            <span class="c1"># contours = -1</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isComposite</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Composite glyph -&gt; </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s1"> &lt;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compositItem</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">glyf</span><span class="p">)</span>
                <span class="c1">#g.buildVertices()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create glyph instance and process the font glyph item</span>
                <span class="n">g</span><span class="o">.</span><span class="n">extractContours</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">(</span><span class="n">glyf</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">contours2array</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">yMin</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">buildVertices</span><span class="p">()</span>
            <span class="c1"># Composit glyph</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isComposite</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">glyphBands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeGlyphBands</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>
            <span class="c1"># Glyph has contours</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">glyphBands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeGlyphBands</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Save the glyph data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">BASE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span><span class="p">)</span>

        <span class="c1"># Extract layered colored glyphs if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">==</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span><span class="p">:</span>
            <span class="n">toDelete</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">unic</span><span class="p">,</span> <span class="n">layers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">father</span> <span class="o">=</span> <span class="n">glyf</span><span class="p">[</span><span class="n">unic</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">father</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">toDelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unic</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">g_width</span> <span class="o">=</span> <span class="n">father</span><span class="o">.</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">father</span><span class="o">.</span><span class="n">xMin</span>
                <span class="n">g_height</span> <span class="o">=</span> <span class="n">father</span><span class="o">.</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">father</span><span class="o">.</span><span class="n">yMin</span>
                <span class="n">signs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">glyf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

                    <span class="n">code</span> <span class="o">=</span> <span class="n">key_from_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">glyferize</span><span class="p">(</span><span class="n">glyf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">setMetric</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">extractContours</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">(</span><span class="n">glyf</span><span class="p">))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">contours2array</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">father</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">father</span><span class="o">.</span><span class="n">yMin</span><span class="p">,</span>
                            <span class="n">xs</span><span class="o">=</span><span class="n">g_width</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">g_height</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">buildVertices</span><span class="p">()</span>
                    <span class="n">glyphBands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeGlyphBands</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span><span class="p">,</span>
                            <span class="n">layered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>
                    <span class="n">signs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cglyphs</span><span class="p">[</span><span class="n">unic</span><span class="p">]</span> <span class="o">=</span> <span class="n">signs</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">toDelete</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="c1"># Hack to extract .notdef glyph if it has curves</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;.notdef&#39;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">glyf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">notdef</span> <span class="o">=</span> <span class="n">glyferize</span><span class="p">(</span><span class="n">glyf</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">notdef</span><span class="o">.</span><span class="n">setMetric</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">notdef</span><span class="o">.</span><span class="n">extractContours</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getCoordinates</span><span class="p">(</span><span class="n">glyf</span><span class="p">))</span>
            <span class="n">notdef</span><span class="o">.</span><span class="n">contours2array</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">notdef</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">notdef</span><span class="o">.</span><span class="n">yMin</span><span class="p">)</span>
            <span class="n">notdef</span><span class="o">.</span><span class="n">buildVertices</span><span class="p">()</span>
            <span class="n">glyphBands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeGlyphBands</span><span class="p">(</span><span class="n">notdef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nBands</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glyphBands</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">notdef</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">BASE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">notdef</span><span class="o">.</span><span class="n">dataTable</span>

        <span class="n">iBandOffset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="p">)</span>
        <span class="c1"># Values that come out the width in the shader must be corrected in</span>
        <span class="c1"># the following while because at avery adjustment all subsequent</span>
        <span class="c1"># data are moved.</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
                    <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span> <span class="o">+</span> <span class="n">iBandOffset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="p">(</span><span class="n">iBandOffset</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">toAdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="n">iBandOffset</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4095</span><span class="p">)</span>
            <span class="c1">#NOTE: non capisco il commento, qui non metti zeri.</span>
            <span class="c1"># Andrebbero messi? E dove?</span>
            <span class="c1"># Vanno messi gli zeri ai banddata che riflettono lo</span>
            <span class="c1"># spostamento</span>
            <span class="n">bandDataIndex</span> <span class="o">=</span> <span class="n">iBandOffset</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">iBandOffset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="p">[:</span><span class="n">bandDataIndex</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">toAdd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="p">[</span><span class="n">bandDataIndex</span><span class="p">:])</span>
            <span class="c1">#NOTE: tradurre</span>
            <span class="c1"># Si aggiunge solo il primo offset dal primo valkore di ind in poi</span>
            <span class="c1"># e si ricalcola tutto</span>
            <span class="n">iBandOffset</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">+=</span> <span class="n">toAdd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ss</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">texelWidth</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">curvesLength</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">texelWidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">texelWidth</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesArrayShape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">texelWidth</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curvesData</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvesArray</span><span class="p">[:</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">numElements</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">iBandOffset</span><span class="p">)</span>
                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">round</span><span class="p">(</span><span class="n">numElements</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
        <span class="c1"># array bands</span>
        <span class="n">texelWidth</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">bandsArrayLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">texelWidth</span>

        <span class="n">maxInt</span> <span class="o">=</span> <span class="n">iBandOffset</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">maxInt</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Bands Array is of type uint16&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">maxInt</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Bands Array is of type uint32&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Index max malue in the bansArray exceded&#39;</span>
                    <span class="s1">&#39; the maximum allowed uint32 maximum value!!!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bandsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">texelWidth</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Creates bands array header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">iBandCount</span><span class="p">,</span> <span class="n">iBandOffset</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandsArray</span><span class="p">[:</span><span class="n">header</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandsData</span>

        <span class="c1"># Wrap bandsData if x exceeeds texture wifth</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bandsArray</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandsArrayShape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">texelWidth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bands Array shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bandsArrayShape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="FontDistiller.save"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">defaultDir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save fontTable to pickled file.</span>

<span class="sd">            Args:</span>
<span class="sd">                outfile (str): pathname of output file</span>

<span class="sd">            Returns:</span>
<span class="sd">                str: pathname of output file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvesArray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;curvesArray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvesArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;curvesArrayShape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvesArrayShape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;bandsArray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandsArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;bandsArrayShape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandsArrayShape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;creationTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">==</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">LAYER_COLOR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;colorsArray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorsArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;colorsArrayShape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorsArrayShape</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">colored</span> <span class="o">==</span> <span class="n">GlyphTypes</span><span class="o">.</span><span class="n">CBDT_COLOR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;colorsArray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">defaultDir</span><span class="p">:</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">FontDistiller</span><span class="o">.</span><span class="n">NBF_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">FontDistiller</span><span class="o">.</span><span class="n">NBF_DIR</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Font file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fontFile</span><span class="si">}</span><span class="s2"> has been&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; distilled to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> file&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>

<div class="viewcode-block" id="FontDistiller.buildColorsLayerArray"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.buildColorsLayerArray">[docs]</a>    <span class="k">def</span> <span class="nf">buildColorsLayerArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build array for layered colored glyphs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add Composite Glyph for colored ones</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">glyf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">unic</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">unic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">glyhBaseCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">colorId</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;colorID&#39;</span><span class="p">]</span>
                <span class="n">glyphName</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">baseGlyphLoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cglyphs</span><span class="p">[</span><span class="n">unic</span><span class="p">][</span><span class="n">glyphName</span><span class="p">]</span><span class="o">.</span><span class="n">glyphParam</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">base</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">*</span><span class="n">baseGlyphLoc</span><span class="p">,</span> <span class="n">colorId</span><span class="p">))</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">key_from_value</span><span class="p">(</span><span class="n">unic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">glyhBaseCount</span><span class="p">,</span>
                        <span class="n">code</span><span class="p">,</span> <span class="n">base</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Added colored glyph: </span><span class="si">{</span><span class="n">unic</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="s1">&#39;gpc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">last</span><span class="p">))</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">last</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="mi">2</span><span class="p">))))</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="c1">## Add curves array colors start index</span>
        <span class="n">offsetToColor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="n">layers</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offsetToColor</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">palettes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>

        <span class="n">texelWidth</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">texelWidth</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">colorsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">texelWidth</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorsArray</span><span class="p">[:</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">colorsArrayShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">texelWidth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Colors Array shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">colorsArrayShape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;coloredGlyphs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_from_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coloredGlyphs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

<div class="viewcode-block" id="FontDistiller.buildColorCBDTArray"><a class="viewcode-back" href="../../api/index.html#litGL.fontDistiller.FontDistiller.buildColorCBDTArray">[docs]</a>    <span class="k">def</span> <span class="nf">buildColorCBDTArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build atlas array for glyphs defined as bitmaps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">glyferize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Glyph</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">codePoint</span> <span class="o">=</span> <span class="n">reversed_cmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="o">.</span><span class="n">getGlyphID</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">charCode</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">codePoint</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">codePoint</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">g</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">charCode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">charCode</span><span class="p">)]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">imageData</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">getbands</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">height</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">width</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;horz_advance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">width</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;vAdvance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">index</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">BearingX</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">metric</span><span class="o">.</span><span class="n">width</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">BearingY</span> <span class="o">-</span> <span class="n">metric</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">metric</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;xMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">width</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;xMin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;yMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">height</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;yMin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;printable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">fileExtension</span>
            <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span><span class="p">[</span><span class="s1">&#39;glyphTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GlyphTypes</span><span class="o">.</span><span class="n">CBDT_COLOR</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">g</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face</span><span class="p">[</span><span class="s1">&#39;CBDT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strikeData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">BitmapAtlas</span><span class="p">()</span>
        <span class="n">reversed_cmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">reversed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reversed_cmap</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">metrics</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">glyferize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">buildVertices</span><span class="p">()</span>

            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">atlas</span><span class="o">.</span><span class="n">getFreeSpot</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">height</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">height</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Cannot store glyph in atlas!&#39;</span>
                        <span class="s1">&#39; Increase it! &gt;&gt; </span><span class="si">%d</span><span class="s1"> &lt;&lt;&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="n">atlas</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="n">u0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span>     <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span>     <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

            <span class="n">texcoords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">],</span> <span class="p">[</span><span class="n">u1</span><span class="p">,</span> <span class="n">v0</span><span class="p">],</span> <span class="p">[</span><span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">],</span> <span class="p">[</span><span class="n">u0</span><span class="p">,</span> <span class="n">v1</span><span class="p">]]</span>

            <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="s1">&#39;tex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texcoords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">cp</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="n">g</span><span class="o">.</span><span class="n">cp</span><span class="p">()]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fontTable</span><span class="p">[</span><span class="s1">&#39;glyphs&#39;</span><span class="p">][</span><span class="n">g</span><span class="o">.</span><span class="n">cp</span><span class="p">()]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataTable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">atlas</span><span class="o">.</span><span class="n">data</span></div></div>


<span class="c1"># =============================================================================</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Distill, i.e. extract glyphs from a ttf&quot;</span>
            <span class="s2">&quot; or odf file and save them to an nbf file for later&quot;</span>
            <span class="s2">&quot; usage by LitGL.&quot;</span><span class="p">))</span>

    <span class="c1"># Font file</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input font file&#39;</span><span class="p">)</span>

    <span class="c1"># Output nbf font file</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output </span><span class="si">%s</span><span class="s1"> file&#39;</span>
            <span class="o">%</span> <span class="n">FontDistiller</span><span class="o">.</span><span class="n">EXT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--bands&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of bands&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Force overwriting of output file&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">const</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Verbose processing (logging) level.&#39;</span>
            <span class="s2">&quot; Add more &#39;v&#39; to increase verbosity. Must be the last option.&quot;</span><span class="p">)</span>

    <span class="c1"># Process options</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">rich.logging</span> <span class="kn">import</span> <span class="n">RichHandler</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">rootLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
            <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> -  </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">,))</span>
            <span class="n">rootLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
            <span class="n">rootLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">.</span><span class="si">%(funcName)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
            <span class="n">DATEFMT</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%X</span><span class="s2">]&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">FORMAT</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="n">DATEFMT</span><span class="p">,</span>
                    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">RichHandler</span><span class="p">()])</span>
            <span class="n">rootLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;rich&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Output file </span><span class="si">{</span><span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2"> exists,&quot;</span>
                <span class="s2">&quot; distillation aborted.&quot;</span><span class="p">)</span>
    <span class="n">FontDistiller</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">defaultDir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/ogs.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">litGL package reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changes</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">litGL 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">litGL.fontDistiller</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020-2021, Nicola Creati, Roberto Vidmar.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.0.
    </div>
  </body>
</html>